<html>
	<head>
		<script type="application/javascript">
			/************************************
			 * STATE SYNCHRONIZATION
			 ************************************/
			var currentViewState = {"version": 0};

			function poll() {
				var req = new XMLHttpRequest();
				req.open("get", "/listen/%%pagekey%%?p=" + currentViewState["version"], true);
				req.onerror = function (e) {
					console.error(req.statusText);
					poll();
				}
				req.onload = function (e) {
					if (req.readyState === 4) {
						var rsp = req.responseText;
						console.log(rsp);
						updateState(JSON.parse(rsp));
						poll();
					}
				}
				req.send(null);
			}

			function push(obj) {
				var req = new XMLHttpRequest();
				req.open("post", "/update/%%pagekey%%", true);
				req.send(JSON.stringify(obj));
			}

			function pushBgImage(img) {
				push({
						"type": "bgimage",
						"bgimage": img,
						});
			}

			function updateState(nu) {
				// If bgimage text equals the old state, update it to the new state (don't overwrite edits).
				var bgval = document.getElementById("bgimage").value;
				if (bgval == "" || bgval == currentViewState["bgimage"]) {
					document.getElementById("bgimage").value = nu["bgimage"];
				}
				if (currentViewState["bgimage"] != nu["bgimage"]) {
					// Start loading the new image to display.
					reloadBackground(nu["bgimage"]);
				}
				currentViewState = nu;
				// repaint the canvas?
			}

			// Kick off a poll() to get the initial state.
			poll();

			/************************************
			 * CANVAS PAINTING
			 ************************************/

			var bgimage = null;

			function reloadBackground(url) {
				var image = new Image();
				image.onload = function() {
					bgimage = image;
					var canv = document.getElementById("canv");
					canv.width = image.width;
					canv.height = image.height;
					paintCanv();
				};
				image.src = url;
			}

			// Draws the entire canvas.
			function paintCanv() {
				var canv = document.getElementById("canv");
				var ctx = canv.getContext("2d");
				var w = canv.width;
				var h = canv.height;
				ctx.clearRect(0, 0, w, h);
				if (bgimage == null) {
					ctx.fillStyle="#168820";
					ctx.fillRect(0, 0, w, h);
				} else {
					ctx.drawImage(bgimage, 0, 0);
				}
				for (var key in currentViewState["markers"]) {
					if (currentViewState["markers"].hasOwnProperty(key)) {
						paintMarker(ctx, currentViewState["markers"][key]);
					}
				}
			}

			function paintMarker(ctx, marker) {
				ctx.fillStyle = marker["color"]
				setMarkerPath(ctx, marker);
				console.log(marker);
				ctx.fill();
			}

			function setMarkerPath(ctx, marker) {
				ctx.beginPath();
				var geo = geometry[marker["shape"]];
				var rot = marker["rotation"];
				var c = {x: marker["posx"], y: marker["posy"]};
				var s = marker["size"];
				var points = [];
				for (var i = 0; i < geo.length; i++) {
					var p = add(rotate(geo[i].x * s, geo[i].y * s, rot), c);
					ctx.lineTo(p.x, p.y);
				}
				ctx.closePath();
			}

			/************************************
			 * MATH AND GEOMETRY UTILS
			 ************************************/

			function dot(a, b) {
				return a.x*b.x+a.y*b.y;
			}

			function cross(a, b) {
				return a.x*b.y-a.y*b.x;
			}

			function mag(a) {
				return Math.sqrt(dot(a,a));
			}

			function add(a, b) {
				return {x: a.x + b.x, y: a.y + b.y};
			}

			function rotate(x, y, d) {
				return {x: Math.cos(d) * x + Math.sin(d) * y, y: Math.cos(d) * y - Math.sin(d) * x};
			}

			var geometry = [
				[{x: 0.0, y: 1.0}, {x: 1.0, y: -1.0},{x: 0.0, y: -0.5}, {x: -1.0, y: -1.0}] // Shape 0: Caret.
			];

			/************************************
			 * INTERFACE
			 ************************************/
			var grabpt = {x: 0, y: 0}
			var selectedMarker = null;

			function eventToLoc(e) {
				var canv = document.getElementById("canv");
				var rect = canv.getBoundingClientRect();
				return {x: e.clientX-rect.left, y: e.clientY-rect.top};
			}

			function mouseDown(e) {
				grabpt = eventToLoc(e);
				var ctx = document.getElementById("canv").getContext("2d");
				selectedMarker = null;
				for (var key in currentViewState["markers"]) {
					if (currentViewState["markers"].hasOwnProperty(key)) {
						var m = currentViewState["markers"][key];
						setMarkerPath(ctx, m);
						if (ctx.isPointInPath(grabpt.x, grabpt.y)) {
							selectedMarker = key;
							break;
						}
					}
				}
				if (selectedMarker == null) {
					selectedMarker = "TODO";
					var m = {
						"posx": grabpt.x,
						"posy": grabpt.y,
						"rotation": 0.0,
						"color": "#000000",
						"label": "",
						"size": 16,
						"shape": 0
					};
					currentViewState["markers"]["TODO"] = m;
					// TODO: use a new random ID.
					// TODO: Push the new marker.
				}
				paintCanv();
			}

			function mouseUp(e) {
				// TODO: Push the change.
				selectedMarker = null;
			}

			function mouseMotion(e) {
				if (selectedMarker != null) {
					newpoint = eventToLoc(e);
					var m = currentViewState["markers"][selectedMarker];
					var x = m["posx"];
					var y = m["posy"];
					var pdelta = {x: x - grabpt.x, y: y - grabpt.y};
					var ndelta = {x: newpoint.x - x, y: newpoint.y - y};
					var dist = mag(pdelta);
					if (dist == 0) {
						return;
					}
					var ndeltamag = mag(ndelta);
					ndelta.x = ndelta.x / ndeltamag;
					ndelta.y = ndelta.y / ndeltamag;
					m["posx"] = -dist*ndelta.x + newpoint.x;
					m["posy"] = -dist*ndelta.y + newpoint.y;
					m["rotation"] = m["rotation"] + Math.atan2(cross(pdelta,ndelta),-dot(pdelta,ndelta));
					grabpt = newpoint;
					paintCanv();
				}
			}
		</script>
	</head>
	<body>
		<div style="text-align:center; max-width:100%; height:800px; overflow: scroll">
			<canvas id="canv" width="800" height="800"/>
		</div>
		<div>
			<label>Set background:
			 	<input id="bgimage" type="text"/>
				<input type="button" onclick="pushBgImage(document.getElementById('bgimage').value);" value="Commit"/>
			</label>
		</div>
		<script>
			canv.onmousedown = mouseDown;
			document.onmouseup = mouseUp;
			canv.onmousemove = mouseMotion;
			paintCanv();
		</script>
	</body>
</html>
